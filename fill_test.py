"""Fill test evaluations via HTTP to see the report."""
import requests
import re

BASE = "https://web-production-28ff.up.railway.app"

EVALUATORS = [
    ("6214a498-a0d4-4798-a46e-8747b0dda3af", "Андрюшин"),
    ("8b77c3ed-c9a8-41a8-9373-3abd194ed58a", "Паршин"),
    ("ab03a69b-1bf5-4581-85c5-167486bcaf17", "Мехонцев"),
    ("3238cb85-152c-4d56-a31a-57b645047daa", "Панфёров"),
]

Q_CODES = ["D1", "D2", "D3", "O1", "O2", "O3", "X1", "X2", "X3", "L1", "L2", "L3"]

TEST_DATA = [
    {
        "scores": {"D1": 5, "D2": 4, "D3": 4, "O1": 5, "O2": 4, "O3": 5, "X1": 4, "X2": 5, "X3": 4, "L1": 4, "L2": 5, "L3": 4},
        "texts": {
            "D1": "Роман всегда выполняет обещания в срок. Когда мне нужны были данные по текучести для квартального отчёта — получил их на день раньше дедлайна, причём в идеальной структуре.",
            "D2": "Когда возникла проблема с массовым увольнением в техотделе, Роман не стал ждать указаний — сам организовал exit-интервью, выявил причины и предложил план действий за 3 дня.",
            "D3": "За последние 3 квартала качество HR-процессов стабильно высокое. Нет провалов, сроки найма улучшились. Системный подход виден.",
            "O1": "Роман сам инициировал внедрение системы OKR для всех хэдов, не дожидаясь запроса от CEO. Это реально улучшило прозрачность целей.",
            "O2": "Когда сорвался онбординг нового разработчика из-за ошибки рекрутера — Роман сразу взял на себя ответственность, лично провёл первый день и перестроил процесс.",
            "O3": "Заранее подготовил план найма на Q1, ещё до того как руководители подали заявки. Предвидел рост команды аналитики и начал поиск раньше.",
            "X1": "Когда мне нужна была помощь с описанием вакансии — Роман подключился в тот же день, предложил структуру и помог с текстом. Быстро и по делу.",
            "X2": "Его решения по HR-политике всегда учитывают специфику разных команд. Не навязывает единый подход, а адаптирует под контекст каждого отдела.",
            "X3": "В совместном проекте по employer branding Роман взял на себя не только HR-часть, но и координацию с маркетингом. Вышел далеко за рамки своей зоны.",
            "L1": "HR-команда работает автономно: рекрутеры сами ведут вакансии, есть чёткие процессы. Когда Роман был в отпуске — ничего не встало.",
            "L2": "Построенная система адаптации новых сотрудников работает как часы. Чек-листы, менторы, обратная связь на 30/60/90 дней — всё автоматизировано.",
            "L3": "Вижу рост людей в его команде. Рекрутер, который пришёл джуном, сейчас самостоятельно закрывает senior-позиции. Роман вкладывается в развитие.",
        },
        "advice": "Роман — один из сильнейших лидеров в команде. Совет: больше делиться HR-экспертизой с другими хэдами через регулярные сессии или workshops."
    },
    {
        "scores": {"D1": 4, "D2": 3, "D3": 4, "O1": 4, "O2": 3, "O3": 4, "X1": 5, "X2": 4, "X3": 3, "L1": 3, "L2": 4, "L3": 5},
        "texts": {
            "D1": "В целом на Романа можно положиться по срокам. Были пара случаев задержек с отчётами, но в критических вопросах всегда доставляет.",
            "D2": "Справляется с препятствиями, но иногда слишком долго анализирует прежде чем действовать. Хотелось бы больше скорости в принятии решений.",
            "D3": "Результаты стабильные — уровень не падает. Но и взрывного роста не наблюдаю. Крепкий середняк, что для HR — хорошо.",
            "O1": "Периодически приходит с инициативами — например, предложил пересмотреть систему грейдов. Но не все инициативы доводит до конца.",
            "O2": "Берёт ответственность, но иногда чувствуется, что предпочитает подождать и посмотреть, как развивается ситуация, прежде чем вмешаться.",
            "O3": "Хорошо предвидит тренды в найме. Заранее предупредил о сложностях с поиском аналитиков в текущем рынке — и оказался прав.",
            "X1": "Роман всегда готов помочь, реагирует быстро. Один из самых отзывчивых коллег. Когда нужна консультация по людям — первый к кому иду.",
            "X2": "Старается учитывать потребности всех команд. Но иногда HR-процессы кажутся слишком универсальными — хотелось бы больше кастомизации.",
            "X3": "В совместной работе делает свою часть хорошо, но редко выходит за рамки. Вклад стабильный, но не выдающийся.",
            "L1": "Команда может работать без него, но чувствуется зависимость от его решений в нестандартных ситуациях. Нужно больше делегирования.",
            "L2": "Процессы найма и адаптации хорошо выстроены. Документация есть. Но система оценки эффективности ещё в процессе.",
            "L3": "Заметен рост его людей — особенно HRBP. Роман явно инвестирует время в менторинг. Одна из его сильнейших сторон.",
        },
        "advice": "Хороший HR-лидер. Рекомендую больше работать над скоростью принятия решений и доведением инициатив до конца."
    },
    {
        "scores": {"D1": 4, "D2": 4, "D3": 5, "O1": 3, "O2": 4, "O3": 3, "X1": 4, "X2": 3, "X3": 0, "L1": 4, "L2": 3, "L3": 4},
        "texts": {
            "D1": "Роман надёжен — если пообещал результат, можно не проверять. Качество HR-аналитики, которую он предоставляет, высокое.",
            "D2": "Хорошо справляется с нестандартными ситуациями. Когда был конфликт между двумя менеджерами — провёл медиацию и решил вопрос профессионально.",
            "D3": "Самый стабильный показатель в компании по time-to-hire и retention. Каждый квартал — улучшение или как минимум удержание уровня.",
            "O1": "Инициативы есть, но хотелось бы видеть больше смелых предложений по изменению культуры и компенсационной политики.",
            "O2": "Быстро реагирует на проблемы. Когда был инцидент с утечкой зарплатных данных — взял на себя расследование и закрыл за сутки.",
            "O3": "Соответствует ожиданиям по превентивной работе, но не всегда предвидит проблемы заранее. Скорее реагирует быстро, чем предупреждает.",
            "X1": "Всегда на связи, отвечает быстро. Когда нужна была срочная помощь с оффером для кандидата — всё решил за 2 часа.",
            "X2": "Иногда HR-решения кажутся оторванными от бизнес-контекста. Хотелось бы, чтобы Роман глубже погружался в специфику каждой функции.",
            "X3": "",
            "L1": "Команда работает хорошо. HR-операции не зависят от Романа в ежедневном режиме. Это признак хорошо построенной системы.",
            "L2": "Базовые процессы работают. Но масштабирование — вопрос. При росте компании текущие процессы могут не выдержать.",
            "L3": "Люди растут. Его рекрутер получил повышение, HRBP взял на себя больше ответственности. Видно, что Роман в это вкладывается.",
        },
        "advice": "Роман — стабильный лидер. Зона роста: больше стратегического мышления и влияния на бизнес-решения через HR-экспертизу."
    },
    {
        "scores": {"D1": 3, "D2": 4, "D3": 3, "O1": 4, "O2": 5, "O3": 4, "X1": 3, "X2": 4, "X3": 4, "L1": 0, "L2": 4, "L3": 0},
        "texts": {
            "D1": "Соответствует ожиданиям. Задачи выполняются, но иногда хотелось бы более глубокой проработки — например, аналитика по текучести могла бы быть детальнее.",
            "D2": "Когда процесс буксует — находит способ двигаться вперёд. Вспоминаю случай, когда заморозили бюджет на найм, а Роман нашёл альтернативные каналы и закрыл 3 позиции.",
            "D3": "Результаты нормальные, но без явного тренда вверх. Уровень стабильный, что само по себе неплохо, но хотелось бы видеть прогресс.",
            "O1": "Приходит с инициативами достаточно часто. Последняя — программа внутреннего менторства. Ещё на этапе пилота, но идея сильная.",
            "O2": "Одна из сильнейших сторон. Когда что-то идёт не так — Роман первый, кто говорит 'это моя зона, я разберусь'. Не перекладывает, не ищет виноватых.",
            "O3": "Хорошо видит риски в людях — заранее предупредил о возможном уходе ключевого разработчика, и мы успели подготовить retention-план.",
            "X1": "Бывает сложно до него достучаться в загруженные периоды. Отвечает, но не всегда с той скоростью, которую хотелось бы.",
            "X2": "Стал лучше в этом за последний квартал. Чаще приходит на встречи продуктовых команд, задаёт правильные вопросы. Прогресс есть.",
            "X3": "В совместном проекте по EVP (Employee Value Proposition) сделал больше, чем от него ожидали. Привлёк внешних экспертов и провёл исследование.",
            "L1": "",
            "L2": "Процессы документированы и работают. Новые члены HR-команды быстро вливаются благодаря хорошей онбординг-системе внутри отдела.",
            "L3": "",
        },
        "advice": "Роман растёт как лидер. Главный совет — усилить коммуникацию и доступность для коллег в пиковые периоды. Также стоит инвестировать в стратегическое HR-планирование."
    },
]


def find_eval_id_for_target(token, target_substring):
    """Find evaluation ID for target manager by scraping the index page."""
    r = requests.get(f"{BASE}/evaluate/{token}")
    if r.status_code != 200:
        return None

    links = re.findall(r'href="(/evaluate/[^"]+/person/(\d+))"', r.text)
    names = re.findall(r'class="font-semibold[^>]*>([^<]+)<', r.text)

    if len(links) != len(names):
        print(f"  WARNING: {len(links)} links vs {len(names)} names")
        return None

    for (href, eid), name in zip(links, names):
        if target_substring.lower() in name.lower():
            return int(eid)
    return None


def submit_evaluation(token, eval_id, data):
    """Submit evaluation form data."""
    form = {}
    for code in Q_CODES:
        form[f"score_{code}"] = str(data["scores"][code])
        form[f"justification_{code}"] = data["texts"].get(code, "")
    form["advice"] = data.get("advice", "")

    url = f"{BASE}/evaluate/{token}/person/{eval_id}/save"
    r = requests.post(url, data=form, allow_redirects=True)
    return r.status_code


if __name__ == "__main__":
    target = "Дунаев"
    print(f"Filling test evaluations for manager containing '{target}'")
    print(f"From {len(EVALUATORS)} evaluators\n")

    for i, (token, evaluator_name) in enumerate(EVALUATORS):
        print(f"[{i+1}/{len(EVALUATORS)}] {evaluator_name} (token: {token[:12]}...)")
        eval_id = find_eval_id_for_target(token, target)
        if not eval_id:
            print("  Could not find evaluation, skipping")
            continue
        print(f"  Evaluation ID: {eval_id}")
        status = submit_evaluation(token, eval_id, TEST_DATA[i])
        print(f"  Submitted -> {status}")

    print("\n=== DONE ===")
    print(f"View the report:")
    print(f"  1. Open: {BASE}/admin/login")
    print(f"  2. Password: admin2026")
    print(f"  3. Go to: Reports -> period -> Roman Dunaev")
