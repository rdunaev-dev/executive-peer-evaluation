{% extends "base.html" %}
{% block title %}–û—Ç—á—ë—Ç: {{ manager.name }}{% endblock %}

{% block content %}
<div class="mb-6">
    <a href="{{ url_for('admin_reports', period_id=period.id) }}" class="text-sm text-brand-600 hover:text-brand-800 transition flex items-center gap-1">
        <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/></svg>
        –ù–∞–∑–∞–¥ –∫ —Å–ø–∏—Å–∫—É –æ—Ç—á—ë—Ç–æ–≤
    </a>
</div>

{% if not report %}
<div class="bg-white rounded-2xl shadow-lg shadow-slate-200/50 border border-slate-100 p-12 text-center">
    <div class="text-4xl mb-4">üì≠</div>
    <h3 class="text-lg font-bold text-slate-900 mb-2">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</h3>
    <p class="text-sm text-slate-500">–î–ª—è —ç—Ç–æ–≥–æ —Ä—É–∫–æ–≤–æ–¥–∏—Ç–µ–ª—è –µ—â—ë –Ω–µ—Ç –∑–∞–ø–æ–ª–Ω–µ–Ω–Ω—ã—Ö –æ—Ü–µ–Ω–æ–∫ –≤ –¥–∞–Ω–Ω–æ–º –ø–µ—Ä–∏–æ–¥–µ</p>
</div>
{% else %}

<!-- Header with Grade -->
<div class="bg-white rounded-2xl shadow-lg shadow-slate-200/50 border border-slate-100 p-6 mb-6">
    <div class="flex items-center gap-4 mb-6">
        <div class="w-16 h-16 bg-gradient-to-br from-brand-500 to-indigo-600 rounded-2xl flex items-center justify-center text-white font-bold text-2xl shadow-lg shadow-brand-500/25">
            {{ manager.name[0] }}
        </div>
        <div class="flex-1">
            <h1 class="text-xl font-bold text-slate-900">{{ manager.name }}</h1>
            <div class="text-sm text-slate-500">{{ manager.position }}</div>
            <div class="text-xs text-slate-400 mt-1">{{ period.name }} ¬∑ –û—Ü–µ–Ω—â–∏–∫–æ–≤: {{ report.evaluator_count }}</div>
        </div>
        <div class="text-center">
            {% set g = grade_labels[report.grade] %}
            <div class="w-20 h-20 rounded-2xl flex flex-col items-center justify-center
                {% if report.grade == 'A' %}bg-emerald-100 border-2 border-emerald-300
                {% elif report.grade == 'B' %}bg-blue-100 border-2 border-blue-300
                {% else %}bg-amber-100 border-2 border-amber-300{% endif %}">
                <div class="text-2xl font-extrabold
                    {% if report.grade == 'A' %}text-emerald-700
                    {% elif report.grade == 'B' %}text-blue-700
                    {% else %}text-amber-700{% endif %}">
                    {{ report.grade }}
                </div>
                <div class="text-xs font-bold
                    {% if report.grade == 'A' %}text-emerald-600
                    {% elif report.grade == 'B' %}text-blue-600
                    {% else %}text-amber-600{% endif %}">
                    {{ report.person_score }} / {{ max_person_score }}
                </div>
            </div>
            <div class="text-xs text-slate-500 mt-1.5 font-medium">{{ g.name }}</div>
        </div>
    </div>

    <!-- Criterion averages -->
    <div class="grid grid-cols-4 gap-3">
        {% for block in blocks %}
        {% set cavg = report.criterion_avgs.get(block.code, 0) %}
        <div class="text-center p-4 rounded-xl bg-slate-50">
            <div class="text-2xl mb-1">{{ block.icon }}</div>
            <div class="text-xl font-bold
                {% if cavg >= 4 %}text-emerald-600
                {% elif cavg >= 3 %}text-blue-600
                {% elif cavg >= 2 %}text-orange-600
                {% else %}text-red-600{% endif %}">
                {{ "%.1f"|format(cavg) }}
            </div>
            <div class="text-xs text-slate-500 mt-1 leading-tight font-medium">{{ block.code }}</div>
            <div class="text-xs text-slate-400 mt-0.5 leading-tight">{{ block.name_ru }}</div>
            <!-- Progress bar -->
            <div class="w-full bg-slate-200 rounded-full h-1.5 mt-2">
                <div class="h-1.5 rounded-full
                    {% if cavg >= 4 %}bg-emerald-500
                    {% elif cavg >= 3 %}bg-blue-500
                    {% elif cavg >= 2 %}bg-orange-500
                    {% else %}bg-red-500{% endif %}"
                     style="width: {{ cavg / max_score * 100 }}%"></div>
            </div>
        </div>
        {% endfor %}
    </div>

    <div class="mt-4 flex items-center gap-3 text-xs text-slate-400">
        <span>–ì—Ä–µ–π–¥—ã:</span>
        <span class="px-2 py-0.5 bg-amber-50 text-amber-600 rounded font-medium">C = 4‚Äì9.9</span>
        <span class="px-2 py-0.5 bg-blue-50 text-blue-600 rounded font-medium">B = 10‚Äì15.9</span>
        <span class="px-2 py-0.5 bg-emerald-50 text-emerald-600 rounded font-medium">A = 16‚Äì20</span>
    </div>
</div>

<!-- Detailed results by criterion -->
{% for block in blocks %}
<div class="bg-white rounded-2xl shadow-lg shadow-slate-200/50 border border-slate-100 overflow-hidden mb-6">
    <div class="p-5 border-b border-slate-100 bg-slate-50">
        <div class="flex items-center justify-between">
            <h2 class="text-base font-bold text-slate-900 flex items-center gap-2">
                {{ block.icon }} {{ block.name }}
                <span class="text-slate-400 font-normal text-sm">‚Äî {{ block.name_ru }}</span>
            </h2>
            {% set cavg = report.criterion_avgs.get(block.code, 0) %}
            <div class="flex items-center gap-2">
                <span class="text-lg font-bold
                    {% if cavg >= 4 %}text-emerald-600
                    {% elif cavg >= 3 %}text-blue-600
                    {% elif cavg >= 2 %}text-orange-600
                    {% else %}text-red-600{% endif %}">
                    {{ "%.1f"|format(cavg) }}
                </span>
                <span class="text-xs text-slate-400">/ {{ max_score }}</span>
            </div>
        </div>
    </div>

    {% for q in block.questions %}
    {% set qdata = report.questions.get(q.code, {}) %}
    <div class="p-5 {% if not loop.last %}border-b border-slate-50{% endif %}">
        <div class="flex items-center justify-between mb-2">
            <div class="text-sm font-semibold text-slate-800">{{ q.text }}</div>
            {% if qdata and qdata.avg_score > 0 %}
            <div class="flex items-center gap-2 flex-shrink-0">
                <span class="text-base font-bold
                    {% if qdata.avg_score >= 4 %}text-emerald-600
                    {% elif qdata.avg_score >= 3 %}text-blue-600
                    {% elif qdata.avg_score >= 2 %}text-orange-600
                    {% else %}text-red-600{% endif %}">
                    {{ "%.1f"|format(qdata.avg_score) }}
                </span>
                <span class="text-xs text-slate-400">({{ qdata.min_score }}‚Äì{{ qdata.max_score }}, n={{ qdata.count }})</span>
            </div>
            {% endif %}
        </div>
        <div class="text-xs text-slate-500 mb-3">{{ q.hint }}</div>

        {% if qdata and qdata.avg_score > 0 %}
        <div class="w-full bg-slate-100 rounded-full h-2 mb-3">
            <div class="h-2 rounded-full transition-all duration-500
                {% if qdata.avg_score >= 4 %}bg-emerald-500
                {% elif qdata.avg_score >= 3 %}bg-blue-500
                {% elif qdata.avg_score >= 2 %}bg-orange-500
                {% else %}bg-red-500{% endif %}"
                 style="width: {{ qdata.avg_score / max_score * 100 }}%"></div>
        </div>
        {% endif %}

        {% if qdata and qdata.justifications %}
        <div class="space-y-2">
            {% for j in qdata.justifications %}
            <div class="flex items-start gap-2 p-3 bg-slate-50 rounded-lg">
                <svg class="w-4 h-4 text-slate-400 mt-0.5 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"/>
                </svg>
                <p class="text-sm text-slate-700 leading-relaxed">{{ j }}</p>
            </div>
            {% endfor %}
        </div>
        {% endif %}
    </div>
    {% endfor %}
</div>
{% endfor %}

<!-- Advices -->
{% if report.advices %}
<div class="bg-white rounded-2xl shadow-lg shadow-slate-200/50 border border-slate-100 overflow-hidden mb-6">
    <div class="p-5 border-b border-slate-100 bg-amber-50">
        <h2 class="text-base font-bold text-slate-900">üí¨ –û–±—â–∏–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ –∏ —Å–æ–≤–µ—Ç—ã –∫–æ–ª–ª–µ–≥</h2>
    </div>
    <div class="p-5 space-y-3">
        {% for a in report.advices %}
        <div class="flex items-start gap-3 p-4 bg-slate-50 rounded-xl">
            <div class="w-8 h-8 bg-amber-100 rounded-lg flex items-center justify-center text-amber-600 flex-shrink-0 text-sm font-bold">
                {{ loop.index }}
            </div>
            <p class="text-sm text-slate-700 leading-relaxed">{{ a }}</p>
        </div>
        {% endfor %}
    </div>
</div>
{% endif %}

{% endif %}
{% endblock %}
